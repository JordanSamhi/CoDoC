public final boolean preparePanel(PanelFeatureState st, KeyEvent event){
    if (isDestroyed()) {
        return false;
    }
    if (st.isPrepared) {
        return true;
    }
    if ((mPreparedPanel != null) && (mPreparedPanel != st)) {
        closePanel(mPreparedPanel, false);
    }
    final Callback cb = getCallback();
    if (cb != null) {
        st.createdPanelView = cb.onCreatePanelView(st.featureId);
    }
    final boolean isActionBarMenu = (st.featureId == FEATURE_OPTIONS_PANEL || st.featureId == FEATURE_ACTION_BAR);
    if (isActionBarMenu && mDecorContentParent != null) {
        mDecorContentParent.setMenuPrepared();
    }
    if (st.createdPanelView == null) {
        if (st.menu == null || st.refreshMenuContent) {
            if (st.menu == null) {
                if (!initializePanelMenu(st) || (st.menu == null)) {
                    return false;
                }
            }
            if (isActionBarMenu && mDecorContentParent != null) {
                if (mActionMenuPresenterCallback == null) {
                    mActionMenuPresenterCallback = new ActionMenuPresenterCallback();
                }
                mDecorContentParent.setMenu(st.menu, mActionMenuPresenterCallback);
            }
            st.menu.stopDispatchingItemsChanged();
            if ((cb == null) || !cb.onCreatePanelMenu(st.featureId, st.menu)) {
                st.setMenu(null);
                if (isActionBarMenu && mDecorContentParent != null) {
                    mDecorContentParent.setMenu(null, mActionMenuPresenterCallback);
                }
                return false;
            }
            st.refreshMenuContent = false;
        }
        st.menu.stopDispatchingItemsChanged();
        if (st.frozenActionViewState != null) {
            st.menu.restoreActionViewStates(st.frozenActionViewState);
            st.frozenActionViewState = null;
        }
        if (!cb.onPreparePanel(st.featureId, st.createdPanelView, st.menu)) {
            if (isActionBarMenu && mDecorContentParent != null) {
                mDecorContentParent.setMenu(null, mActionMenuPresenterCallback);
            }
            st.menu.startDispatchingItemsChanged();
            return false;
        }
        KeyCharacterMap kmap = KeyCharacterMap.load(event != null ? event.getDeviceId() : KeyCharacterMap.VIRTUAL_KEYBOARD);
        st.qwertyMode = kmap.getKeyboardType() != KeyCharacterMap.NUMERIC;
        st.menu.setQwertyMode(st.qwertyMode);
        st.menu.startDispatchingItemsChanged();
    }
    st.isPrepared = true;
    st.isHandled = false;
    mPreparedPanel = st;
    return true;
}